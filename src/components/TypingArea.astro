<div class="flex flex-col w-full h-full items-center py-10 mt-10">
  <span
    class="caps-warning border rounded-2xl flex bg-white w-50 h-17 items-center justify-center text-2xl mb-10 opacity-0"
  ></span>
  <div
    class="relative p-10 rounded-2xl bg-zinc-900 w-[90%] flex items-center justify-center"
  >
    <div
      id="quote-guide"
      class="absolute w-full max-w-4xl font text-white/30 text-3xl/12 h-fit text-start whitespace-pre-wrap tracking-widest"
    >
    </div>
    <div
      id="quote-write"
      class="w-full max-w-4xl text-3xl/12 text-start whitespace-pre-wrap tracking-widest"
    >
    </div>
  </div>
  <div
    class="fixed bottom-10 flex items-center px-5 text-white w-full h-20 justify-center gap-10 text-sm mb-10 font-bold"
  >
    <div class="flex flex-col items-center">
      <p class="time-left">30</p>
      <p class="seconds-left-p">seconds left</p>
    </div>
    <div class="flex flex-col items-center">
      <p class="words-completed">Loading...</p>
      <p>Words completed</p>
    </div>
    <div class="flex flex-col items-center">
      <p class="errors">0</p>
      <p>Errors</p>
    </div>
    <div class="flex flex-col items-center">
      <p class="average">0</p>
      <p>correct/error</p>
    </div>
  </div>
</div>

<script type="module">
  const wordsCompleted = document.querySelector(".words-completed");
  const capsWarning = document.querySelector(".caps-warning");

  const quoteGuide = document.getElementById("quote-guide");
  const quoteWrite = document.getElementById("quote-write");
  const left = document.querySelector(".time-left");
  const secondsLeftP = document.querySelector(".seconds-left-p");
  const errors = document.querySelector(".errors");
  const averageErrors = document.querySelector(".average");

  async function getQuotes() {
    const response = await fetch(
      "https://quoteslate.vercel.app/api/quotes/random?minLength=200&maxLength=400"
    );
    const data = await response.json();
    return data;
  }

  const responseText = await getQuotes();

  function normalizeText(text) {
    return text
      .replace(/\s*\n\s*/g, " ")
      .replace(/[’‘]/g, "'")
      .replace(/[“”]/g, '"')
      .replace(/[—–]/g, "-")
      .normalize("NFKC");
  }

  const normalizedQuote = normalizeText(responseText.quote);

  if (quoteGuide) {
    quoteGuide.textContent = `${normalizedQuote}`;
  }

  const quoteLetters = [];

  quoteLetters.push(normalizeText(responseText.quote));

  const specialKeys = [
    "Shift",
    "Control",
    "Alt",
    "AltGraph",
    "Meta",
    "CapsLock",
    "Tab",
    "ArrowUp",
    "ArrowDown",
    "ArrowLeft",
    "ArrowRight",
    "Escape",
    "Enter",
    "Delete",
    "Home",
    "End",
    "PageUp",
    "PageDown",
    "F1",
    "F2",
    "F3",
    "F4",
    "F5",
    "F6",
    "F7",
    "F8",
    "F9",
    "F10",
    "F11",
    "F12",
  ];

  function updateCaps(e) {
    if (!e.getModifierState) return;

    if (e.getModifierState("CapsLock")) {
      capsWarning.classList.remove("opacity-0");
    } else {
      capsWarning.classList.add("opacity-0");
    }
  }

  ["keydown", "keyup", "mousedown", "touchstart"].forEach((e) =>
    document.addEventListener(e, updateCaps)
  );

  const letters = quoteLetters[0].split("");
  letters.forEach((letter) => {
    const text = document.createElement("span");
    text.textContent = letter;

    text.classList.add("letter", "opacity-30", "relative");
    quoteWrite.appendChild(text);
  });
  const lettersSpan = document.querySelectorAll("#quote-write .letter");
  updateCursor(0, 0);

  capsWarning.classList.add(
    "opacity-0",
    "transition-opacity",
    "duration-200",
    "gap-2"
  );
  capsWarning.innerHTML = `<svg width="30" height="30" viewBox="0 0 24 24" fill="currentColor" class="icon icon-tabler icons-tabler-filled icon-tabler-lock"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 2a5 5 0 0 1 5 5v3a3 3 0 0 1 3 3v6a3 3 0 0 1 -3 3h-10a3 3 0 0 1 -3 -3v-6a3 3 0 0 1 3 -3v-3a5 5 0 0 1 5 -5m0 12a2 2 0 0 0 -1.995 1.85l-.005 .15a2 2 0 1 0 2 -2m0 -10a3 3 0 0 0 -3 3v3h6v-3a3 3 0 0 0 -3 -3" /></svg><span>Caps Lock</span>`;

  let error = 0;
  let correct = 0;
  let gameStarted = false;
  let currentIndex = 0;

  function gameHandler(e) {
    let key = e.key;
    const prevIndex = currentIndex;
    if (!gameStarted) {
      gameStarted = true;
      timeLeft();
    }

    if (e.getModifierState("CapsLock")) {
      capsWarning.classList.remove("opacity-0");
    } else {
      capsWarning.classList.add("opacity-0");
    }

    if (key === "Dead") {
      key = "'";
    }

    if (specialKeys.includes(key)) return;
    if (currentIndex === letters.length) return;

    const expected = letters[currentIndex];
    const currentSpan = lettersSpan[currentIndex];

    if (key === expected) {
      currentSpan.classList.remove("opacity-30", "underline");
      currentSpan.classList.add("text-white");
      correct++;
      currentIndex++;
      updateCursor(prevIndex, currentIndex);
      if (key === " ") {
        wordsAmount(key);
      }
    } else {
      currentSpan.classList.remove("opacity-30");
      currentSpan.classList.add("text-[#F7768E]", "underline");
      error++;
    }
    averageErrors.textContent =
      error === 0 ? "0" : (correct / error).toFixed(2);
    errors.textContent = `${error}`;
  }

  const words = quoteLetters[0].split(" ");

  const totalWords = words.length;
  wordsCompleted.textContent = `0 / ${totalWords}`;

  let intervalo;

  function timeLeft() {
    let time = 30;
    left.textContent = time;
    clearInterval(intervalo);

    intervalo = setInterval(() => {
      time--;
      left.textContent = time;

      if (time <= 0) {
        clearInterval(intervalo);
        left.textContent = "Time limit";
        secondsLeftP.textContent = "reached";

        document.removeEventListener("keydown", gameHandler);
      }
    }, 1000);
  }

  let completed = 1;
  function wordsAmount(key) {
    if (key === " ") {
      wordsCompleted.textContent = `${completed++ + " / " + totalWords}`;
    }
  }

  function updateCursor(prevIndex, newIndex) {
    if (lettersSpan[prevIndex]) {
      lettersSpan[prevIndex].classList.remove(
        "after:absolute",
        "after:left-0",
        "after:top-0",
        "after:h-full",
        "after:w-[2px]",
        "after:bg-white",
        "after:animate-[caret_1s_steps(1)_infinite]",
        "after:content-['']"
      );
    }

    if (lettersSpan[newIndex]) {
      lettersSpan[newIndex].classList.add(
        "relative",
        "after:absolute",
        "after:left-[-2px]",
        "after:top-0",
        "after:h-full",
        "after:w-[2px]",
        "after:bg-white",
        "after:animate-[caret_1s_steps(1)_infinite]",
        "after:content-['']"
      );
    }
  }

  document.addEventListener("keydown", gameHandler);
</script>
