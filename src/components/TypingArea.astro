<div class="flex flex-col w-full h-full items-center py-20 mt-10">
  <span
    class="caps-warning border rounded-2xl flex bg-white w-50 h-17 items-center justify-center text-2xl mb-10"
  ></span>
  <div class="relative">
    <div
      id="quote-guide"
      class="absolute w-full max-w-4xl font text-[#8B949E]/40 text-3xl/12 h-fit text-center whitespace-pre-wrap tracking-widest"
    >
    </div>
    <div
      id="quote-write"
      class="w-full max-w-4xl text-3xl/12 text-center whitespace-pre-wrap tracking-widest"
    >
    </div>
  </div>
</div>

<script type="module">
  async function getQuotes() {
    const response = await fetch(
      "https://quoteslate.vercel.app/api/quotes/random?minLength=200&maxLength=400"
    );
    const data = await response.json();
    return data;
  }

  const responseText = await getQuotes();

  function normalizeText(text) {
    return text
      .replace(/\s*\n\s*/g, " ")
      .replace(/[’‘]/g, "'")
      .replace(/[“”]/g, '"')
      .replace(/[—–]/g, "-")
      .normalize("NFKC");
  }

  const normalizedQuote = normalizeText(responseText.quote);

  const quoteGuide = document.getElementById("quote-guide");
  const quoteWrite = document.getElementById("quote-write");
  if (quoteGuide) {
    quoteGuide.textContent = `${normalizedQuote}`;
  }

  const quoteLetters = [];

  quoteLetters.push(normalizeText(responseText.quote));

  let currentIndex = 0;
  const specialKeys = [
    "Shift",
    "Control",
    "Alt",
    "AltGraph",
    "Meta",
    "CapsLock",
    "Tab",
    "ArrowUp",
    "ArrowDown",
    "ArrowLeft",
    "ArrowRight",
    "Escape",
    "Enter",
    "Delete",
    "Home",
    "End",
    "PageUp",
    "PageDown",
    "F1",
    "F2",
    "F3",
    "F4",
    "F5",
    "F6",
    "F7",
    "F8",
    "F9",
    "F10",
    "F11",
    "F12",
  ];

  function updateCaps(e) {
    if (e.getModifierState?.("CapsLock")) {
      capsWarning.classList.remove("opacity-0");
    } else {
      capsWarning.classList.add("opacity-0");
    }
  }

  ["keydown", "keyup", "mousedown", "touchstart"].forEach((e) =>
    document.addEventListener(e, updateCaps)
  );

  const letters = quoteLetters[0].split("");
  letters.forEach((letter) => {
    const text = document.createElement("span");
    text.textContent = letter;

    text.classList.add("letter", "opacity-30");
    quoteWrite.appendChild(text);
  });

  const lettersSpan = document.querySelectorAll("#quote-write .letter");
  const capsWarning = document.querySelector(".caps-warning");

  capsWarning.classList.add(
    "opacity-0",
    "transition-opacity",
    "duration-200",
    "gap-2"
  );
  capsWarning.innerHTML = `<svg width="30" height="30" viewBox="0 0 24 24" fill="currentColor" class="icon icon-tabler icons-tabler-filled icon-tabler-lock"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 2a5 5 0 0 1 5 5v3a3 3 0 0 1 3 3v6a3 3 0 0 1 -3 3h-10a3 3 0 0 1 -3 -3v-6a3 3 0 0 1 3 -3v-3a5 5 0 0 1 5 -5m0 12a2 2 0 0 0 -1.995 1.85l-.005 .15a2 2 0 1 0 2 -2m0 -10a3 3 0 0 0 -3 3v3h6v-3a3 3 0 0 0 -3 -3" /></svg><span>Caps Lock</span>`;
  document.addEventListener("keydown", (e) => {
    let key = e.key;

    if (e.getModifierState("CapsLock")) {
      capsWarning.classList.remove("opacity-0");
    } else {
      capsWarning.classList.add("opacity-0");
    }

    if (key === "Dead") {
      key = "'";
    }

    if (specialKeys.includes(key)) return;
    if (currentIndex === letters.length) return;

    const expected = letters[currentIndex];
    const currentSpan = lettersSpan[currentIndex];

    if (key === expected) {
      currentSpan.classList.remove("opacity-30", "underline");
      currentSpan.classList.add("text-white");
      currentIndex++;
    } else {
      currentSpan.classList.remove("opacity-30");
      currentSpan.classList.add("text-[#F7768E]", "underline");
    }
  });
</script>
